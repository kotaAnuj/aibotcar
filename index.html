<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Autonomous Car</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: linear-gradient(135deg, #667eea, #764ba2); padding: 20px; color: #333; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1400px; margin: 0 auto; }
        .panel { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        h1 { text-align: center; color: white; font-size: 2.5em; margin-bottom: 20px; grid-column: 1/-1; }
        h2 { color: #4a5568; margin-bottom: 15px; }
        input, textarea, button { width: 100%; padding: 10px; margin: 8px 0; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
        button { background: #48bb78; color: white; font-weight: bold; cursor: pointer; border: none; }
        button:hover { background: #38a169; }
        .btn-danger { background: #f56565; }
        .btn-danger:hover { background: #e53e3e; }
        #carIframe { width: 100%; height: 500px; border: 3px solid #e2e8f0; border-radius: 10px; background: #000; }
        #aiLog { background: #1a202c; color: #68d391; padding: 15px; border-radius: 10px; height: 300px; overflow-y: auto; font-family: monospace; font-size: 13px; }
        video { width: 100%; border-radius: 10px; background: #000; }
        @media (max-width: 1024px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>ü§ñ AI Autonomous Car - DOM Control</h1>
    <div class="grid">
        <!-- Setup Panel -->
        <div class="panel">
            <h2>‚öôÔ∏è Setup</h2>
            <input type="text" id="espUrl" placeholder="ESP32 URL (http://192.168.1.100)" value="http://192.168.1.100">
            <button onclick="loadCar()">üîó Load Car Interface</button>
            <input type="password" id="geminiKey" placeholder="Gemini API Key (AIzaSy...)">
            <button onclick="startCamera()">üìπ Start Camera</button>
            <video id="video" autoplay playsinline style="display:none"></video>
            <canvas id="canvas" style="display:none"></canvas>
            <p style="margin-top:15px; color:#666;">Interval: <input type="number" id="interval" value="2" min="1" max="5" style="width:60px"> seconds</p>
            <button onclick="toggleAuto()" id="autoBtn" disabled>ü§ñ Start Autonomous</button>
            <button class="btn-danger" onclick="emergencyStop()">üõë STOP ALL</button>
        </div>

        <!-- AI Vision -->
        <div class="panel">
            <h2>üëÅÔ∏è AI Vision & Prompt</h2>
            <textarea id="aiPrompt" rows="8">You control a car via DOM buttons. Analyze the image and decide:

FORWARD - move straight ahead
BACKWARD - reverse
LEFT - turn left  
RIGHT - turn right
STOP - stop completely

Respond with ONLY ONE WORD: FORWARD, BACKWARD, LEFT, RIGHT, or STOP
Then add brief reason after a dash.

Example: "FORWARD - path is clear ahead"</textarea>
            <div id="aiLog"></div>
        </div>

        <!-- ESP32 Interface -->
        <div class="panel" style="grid-column: 1/-1;">
            <h2>üöó Car Controller (Embedded ESP32)</h2>
            <iframe id="carIframe" src="about:blank"></iframe>
        </div>
    </div>

    <script>
        let autoMode = false;
        let autoInterval = null;
        let stream = null;

        function log(msg, color = '#68d391') {
            const div = document.getElementById('aiLog');
            const time = new Date().toLocaleTimeString();
            div.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            div.scrollTop = div.scrollHeight;
        }

        function loadCar() {
            const url = document.getElementById('espUrl').value;
            document.getElementById('carIframe').src = url;
            document.getElementById('autoBtn').disabled = false;
            log('Car interface loaded!');
        }

        async function startCamera() {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: 640, height: 480, facingMode: 'environment' } 
            });
            document.getElementById('video').srcObject = stream;
            log('Camera started!');
        }

        function captureFrame() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            canvas.getContext('2d').drawImage(video, 0, 0);
            return canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
        }

        function clickCarButton(command) {
            try {
                const iframe = document.getElementById('carIframe');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // Find button in iframe and click it
                const buttons = iframeDoc.querySelectorAll('button');
                for (let btn of buttons) {
                    const text = btn.textContent.toUpperCase();
                    if (text.includes(command)) {
                        btn.click();
                        log(`‚úì Clicked ${command} button in car interface`, '#68d391');
                        return true;
                    }
                }
                
                // Alternative: try calling iframe's sendCommand function directly
                if (iframe.contentWindow.sendCommand) {
                    iframe.contentWindow.sendCommand(command);
                    log(`‚úì Called sendCommand(${command}) in iframe`, '#68d391');
                    return true;
                }
                
                log('Could not control car - check iframe permissions', '#fc8181');
                return false;
            } catch (error) {
                log('DOM Error: ' + error.message, '#fc8181');
                return false;
            }
        }

        async function aiDecision() {
            const key = document.getElementById('geminiKey').value;
            if (!key) {
                alert('Enter Gemini API key!');
                stopAuto();
                return;
            }

            const image = captureFrame();
            const prompt = document.getElementById('aiPrompt').value;

            log('AI analyzing...', '#fbd38d');

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inline_data: { mime_type: "image/jpeg", data: image } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text.toUpperCase();
                
                // Extract command
                let command = 'STOP';
                if (aiText.includes('FORWARD')) command = 'FORWARD';
                else if (aiText.includes('BACKWARD')) command = 'BACKWARD';
                else if (aiText.includes('LEFT')) command = 'LEFT';
                else if (aiText.includes('RIGHT')) command = 'RIGHT';

                log(`AI: ${command} - ${aiText.substring(0, 50)}`, '#fbd38d');
                
                // Click button via DOM
                clickCarButton(command);

            } catch (error) {
                log('AI Error: ' + error.message, '#fc8181');
            }
        }

        function toggleAuto() {
            if (!autoMode) {
                const interval = parseFloat(document.getElementById('interval').value) * 1000;
                autoMode = true;
                document.getElementById('autoBtn').textContent = '‚è∏Ô∏è Pause Auto';
                document.getElementById('autoBtn').style.background = '#f56565';
                log('üöó AUTONOMOUS MODE STARTED!', '#68d391');
                aiDecision();
                autoInterval = setInterval(aiDecision, interval);
            } else {
                stopAuto();
            }
        }

        function stopAuto() {
            if (autoInterval) clearInterval(autoInterval);
            autoMode = false;
            document.getElementById('autoBtn').textContent = 'ü§ñ Start Autonomous';
            document.getElementById('autoBtn').style.background = '#48bb78';
            clickCarButton('STOP');
            log('‚è∏Ô∏è Auto mode stopped');
        }

        function emergencyStop() {
            stopAuto();
            clickCarButton('STOP');
            log('üõë EMERGENCY STOP!', '#fc8181');
        }

        log('System ready. Load car interface to begin!');
    </script>
</body>
</html>
