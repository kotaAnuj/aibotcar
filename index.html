<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Person Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        #container {
            position: relative;
            max-width: 800px;
            width: 100%;
        }
        
        #videoElement {
            width: 100%;
            border-radius: 10px;
            transform: scaleX(-1);
        }
        
        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1);
        }
        
        #command {
            margin-top: 20px;
            padding: 20px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            font-size: 32px;
            font-weight: bold;
            text-transform: uppercase;
            min-width: 200px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s;
        }
        
        #command.left { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        #command.right { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        #command.forward { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        #command.back { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        
        #status {
            margin-top: 10px;
            color: #888;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ¯ Real-time Person Tracker</h1>
    <div id="container">
        <video id="videoElement" autoplay playsinline></video>
        <canvas id="canvas"></canvas>
    </div>
    <div id="command">READY</div>
    <div id="status">Initializing camera...</div>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const commandDiv = document.getElementById('command');
        const statusDiv = document.getElementById('status');
        
        let model;
        let lastCenter = null;
        let lastBoxSize = null;
        let isProcessing = false;
        
        async function initializeDetector() {
            try {
                statusDiv.textContent = 'Loading AI model...';
                model = await cocoSsd.load();
                statusDiv.textContent = 'Detector ready! Stand in front of camera.';
                return true;
            } catch (error) {
                statusDiv.textContent = 'Error loading detector: ' + error.message;
                return false;
            }
        }
        
        async function setupCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                };
                
                return true;
            } catch (error) {
                statusDiv.textContent = 'Camera error: ' + error.message;
                return false;
            }
        }
        
        function getBoundingBox(bbox) {
            // bbox format: [x, y, width, height]
            return {
                minX: bbox[0],
                minY: bbox[1],
                maxX: bbox[0] + bbox[2],
                maxY: bbox[1] + bbox[3]
            };
        }
        
        function getCenter(box) {
            return {
                x: (box.minX + box.maxX) / 2,
                y: (box.minY + box.maxY) / 2
            };
        }
        
        function getBoxSize(box) {
            const width = box.maxX - box.minX;
            const height = box.maxY - box.minY;
            return width * height;
        }
        
        function generateCommand(currentCenter, currentSize) {
            if (!lastCenter || !lastBoxSize) {
                lastCenter = currentCenter;
                lastBoxSize = currentSize;
                return 'READY';
            }
            
            const deltaX = currentCenter.x - lastCenter.x;
            const sizeChange = (currentSize - lastBoxSize) / lastBoxSize;
            
            lastCenter = currentCenter;
            lastBoxSize = currentSize;
            
            // Thresholds for movement detection
            const horizontalThreshold = 0.05;
            const sizeThreshold = 0.15;
            
            // Priority: Left/Right > Forward/Back
            if (Math.abs(deltaX) > horizontalThreshold) {
                return deltaX > 0 ? 'LEFT' : 'RIGHT';
            } else if (Math.abs(sizeChange) > sizeThreshold) {
                return sizeChange > 0 ? 'BACK' : 'FORWARD';
            }
            
            return 'STRAIGHT';
        }
        
        async function detectPose() {
            if (!model || isProcessing) return;
            
            isProcessing = true;
            
            try {
                const predictions = await model.detect(video);
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // Find person in predictions
                const person = predictions.find(p => p.class === 'person');
                
                if (person) {
                    const bbox = person.bbox;
                    
                    // Get bounding box in our format
                    const box = getBoundingBox(bbox);
                    const center = getCenter(box);
                    const boxSize = getBoxSize(box);
                    
                    // Draw bounding box
                    ctx.strokeStyle = '#00ff00';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(bbox[0], bbox[1], bbox[2], bbox[3]);
                    
                    // Draw center point
                    ctx.fillStyle = '#ff0000';
                    ctx.beginPath();
                    ctx.arc(
                        center.x,
                        center.y,
                        8, 0, 2 * Math.PI
                    );
                    ctx.fill();
                    
                    // Draw confidence score
                    ctx.fillStyle = '#00ff00';
                    ctx.font = '16px Arial';
                    ctx.fillText(
                        `${(person.score * 100).toFixed(0)}%`,
                        bbox[0],
                        bbox[1] - 5
                    );
                    
                    // Generate and display command
                    const command = generateCommand(center, boxSize);
                    commandDiv.textContent = command;
                    commandDiv.className = command.toLowerCase();
                    
                    statusDiv.textContent = `Tracking active | Confidence: ${(person.score * 100).toFixed(0)}% | Size: ${(boxSize / (canvas.width * canvas.height) * 100).toFixed(1)}%`;
                } else {
                    commandDiv.textContent = 'NO PERSON';
                    commandDiv.className = '';
                    statusDiv.textContent = 'No person detected';
                    lastCenter = null;
                    lastBoxSize = null;
                }
            } catch (error) {
                console.error('Detection error:', error);
            }
            
            isProcessing = false;
        }
        
        async function start() {
            const cameraReady = await setupCamera();
            if (!cameraReady) return;
            
            const detectorReady = await initializeDetector();
            if (!detectorReady) return;
            
            // Start detection loop
            setInterval(detectPose, 100); // 10 FPS for smooth tracking
        }
        
        start();
    </script>
</body>
</html>
