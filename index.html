<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Autonomous Car Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #eee;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        h1 {
            text-align: center;
            grid-column: 1 / -1;
            font-size: 2.5em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        h2 {
            color: #81e6d9;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        .status-badge {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }
        .status-connected {
            background: #48bb78;
            color: white;
        }
        .status-disconnected {
            background: #f56565;
            color: white;
        }
        .status-active {
            background: #4299e1;
            color: white;
        }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e0;
            font-weight: 500;
        }
        .input-group input, .input-group textarea {
            width: 100%;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            font-size: 14px;
        }
        .input-group textarea {
            min-height: 100px;
            font-family: inherit;
            resize: vertical;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            margin: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-success {
            background: #48bb78;
            color: white;
        }
        .btn-danger {
            background: #f56565;
            color: white;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        #videoFeed {
            width: 100%;
            border-radius: 10px;
            background: #000;
            margin: 15px 0;
        }
        #aiThoughts {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            border: 1px solid rgba(129, 230, 217, 0.3);
        }
        .thought-entry {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(129, 230, 217, 0.1);
            border-radius: 5px;
        }
        .thought-time {
            color: #81e6d9;
            font-size: 0.85em;
        }
        .thought-action {
            color: #fbd38d;
            font-weight: bold;
        }
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .control-btn {
            padding: 15px;
            background: rgba(66, 153, 225, 0.3);
            border: 2px solid #4299e1;
            color: white;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
        }
        .control-btn:active {
            transform: scale(0.95);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 15px 0;
        }
        .stat-box {
            background: rgba(72, 187, 120, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(72, 187, 120, 0.3);
        }
        .stat-label {
            font-size: 0.85em;
            color: #cbd5e0;
        }
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #81e6d9;
        }
        .warning-box {
            background: rgba(237, 137, 54, 0.2);
            border: 2px solid #ed8936;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ AI Autonomous Car Controller</h1>
        
        <!-- Configuration Panel -->
        <div class="panel">
            <h2>‚öôÔ∏è Configuration</h2>
            
            <div class="input-group">
                <label>ESP32 IP Address:</label>
                <input type="text" id="espIp" placeholder="192.168.1.100" value="192.168.1.100">
            </div>
            
            <div class="input-group">
                <label>Gemini API Key:</label>
                <input type="text" id="geminiKey" placeholder="Your-Gemini-API-Key" value="">
            </div>
            
            <div class="input-group">
                <label>Command Interval (seconds):</label>
                <input type="number" id="commandInterval" value="2" min="1" max="10">
            </div>
            
            <div class="input-group">
                <label>AI System Prompt (How the AI should behave):</label>
                <textarea id="systemPrompt">You are an autonomous car AI. You can see through a camera mounted on the car. Your mission is to navigate safely and avoid obstacles.

Available commands:
- FORWARD: Move the car forward
- BACKWARD: Move the car backward
- LEFT: Turn left
- RIGHT: Turn right
- STOP: Stop all motors

You must respond ONLY with ONE of these commands based on what you see. Analyze the image, identify obstacles, paths, and decide the safest direction.

Respond in this format:
COMMAND: [ONE_COMMAND]
REASON: [Brief explanation of your decision]

Remember: You ARE the car. This is your body. Navigate carefully and make smart decisions every 2 seconds.</textarea>
            </div>
            
            <button class="btn-primary" onclick="testESP()">üîå Test ESP32 Connection</button>
            <button class="btn-success" onclick="startCamera()">üìπ Start Camera</button>
            
            <div style="margin-top: 20px;">
                <span class="status-badge" id="espStatus">ESP32: Not Connected</span>
                <span class="status-badge" id="cameraStatus">Camera: Off</span>
                <span class="status-badge" id="aiStatus">AI: Idle</span>
            </div>
        </div>
        
        <!-- Vision Panel -->
        <div class="panel">
            <h2>üëÅÔ∏è AI Vision Feed</h2>
            <video id="videoFeed" autoplay playsinline></video>
            <canvas id="captureCanvas" style="display: none;"></canvas>
            
            <div style="text-align: center; margin: 15px 0;">
                <button class="btn-success" id="autonomousBtn" onclick="toggleAutonomous()" disabled>
                    ü§ñ Start Autonomous Mode
                </button>
                <button class="btn-danger" onclick="emergencyStop()">
                    üõë EMERGENCY STOP
                </button>
            </div>
        </div>
        
        <!-- AI Thoughts Panel -->
        <div class="panel">
            <h2>üß† AI Decision Log</h2>
            <div id="aiThoughts"></div>
        </div>
        
        <!-- Manual Control Panel -->
        <div class="panel">
            <h2>üéÆ Manual Override</h2>
            <div class="warning-box">
                ‚ö†Ô∏è Manual controls will pause autonomous mode
            </div>
            
            <div class="controls-grid">
                <div></div>
                <button class="control-btn" onclick="sendManualCommand('FORWARD')">‚Üë<br>FORWARD</button>
                <div></div>
                <button class="control-btn" onclick="sendManualCommand('LEFT')">‚Üê<br>LEFT</button>
                <button class="control-btn" onclick="sendManualCommand('STOP')">‚èπ<br>STOP</button>
                <button class="control-btn" onclick="sendManualCommand('RIGHT')">‚Üí<br>RIGHT</button>
                <div></div>
                <button class="control-btn" onclick="sendManualCommand('BACKWARD')">‚Üì<br>BACKWARD</button>
            </div>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Commands Sent</div>
                    <div class="stat-value" id="commandCount">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Uptime</div>
                    <div class="stat-value" id="uptime">0s</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Last Command</div>
                    <div class="stat-value" id="lastCommand">NONE</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Mode</div>
                    <div class="stat-value" id="currentMode">MANUAL</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let espIpAddress = '';
        let geminiApiKey = '';
        let autonomousMode = false;
        let autonomousInterval = null;
        let videoStream = null;
        let commandCount = 0;
        let startTime = Date.now();
        
        // Update uptime
        setInterval(() => {
            const uptime = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('uptime').textContent = uptime + 's';
        }, 1000);
        
        // Test ESP32 connection
        async function testESP() {
            espIpAddress = document.getElementById('espIp').value;
            
            try {
                const response = await fetch(`http://${espIpAddress}/status`);
                const data = await response.json();
                
                document.getElementById('espStatus').textContent = '‚úÖ ESP32: Connected';
                document.getElementById('espStatus').className = 'status-badge status-connected';
                
                logThought('ESP32 connected successfully!', 'SUCCESS');
                alert('‚úÖ ESP32 connected!\n' + JSON.stringify(data, null, 2));
            } catch (error) {
                document.getElementById('espStatus').textContent = '‚ùå ESP32: Failed';
                document.getElementById('espStatus').className = 'status-badge status-disconnected';
                
                logThought('Failed to connect to ESP32', 'ERROR');
                alert('‚ùå Failed to connect to ESP32!\n\nMake sure:\n1. ESP32 is powered on\n2. IP address is correct\n3. You are on the same WiFi network');
            }
        }
        
        // Start camera
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                });
                
                const video = document.getElementById('videoFeed');
                video.srcObject = videoStream;
                
                document.getElementById('cameraStatus').textContent = '‚úÖ Camera: Active';
                document.getElementById('cameraStatus').className = 'status-badge status-connected';
                document.getElementById('autonomousBtn').disabled = false;
                
                logThought('Camera started - AI can now see!', 'SUCCESS');
            } catch (error) {
                alert('‚ùå Failed to access camera!\n\nPlease allow camera permissions.');
                logThought('Camera access denied', 'ERROR');
            }
        }
        
        // Capture frame from video
        function captureFrame() {
            const video = document.getElementById('videoFeed');
            const canvas = document.getElementById('captureCanvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            return canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
        }
        
        // Send command to ESP32
        async function sendCommand(command) {
            if (!espIpAddress) {
                alert('Please test ESP32 connection first!');
                return false;
            }
            
            try {
                const response = await fetch(`http://${espIpAddress}/control`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command })
                });
                
                if (response.ok) {
                    commandCount++;
                    document.getElementById('commandCount').textContent = commandCount;
                    document.getElementById('lastCommand').textContent = command;
                    return true;
                }
                return false;
            } catch (error) {
                logThought('Failed to send command to ESP32', 'ERROR');
                return false;
            }
        }
        
        // Ask Gemini AI for decision
        async function askGeminiForDecision() {
            geminiApiKey = document.getElementById('geminiKey').value;
            
            if (!geminiApiKey) {
                alert('Please enter your Gemini API key!');
                stopAutonomous();
                return;
            }
            
            const imageBase64 = captureFrame();
            const systemPrompt = document.getElementById('systemPrompt').value;
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: systemPrompt },
                                { 
                                    inline_data: {
                                        mime_type: "image/jpeg",
                                        data: imageBase64
                                    }
                                }
                            ]
                        }]
                    })
                });
                
                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                // Parse command from AI response
                const commandMatch = aiResponse.match(/COMMAND:\s*(\w+)/i);
                const reasonMatch = aiResponse.match(/REASON:\s*(.+)/i);
                
                if (commandMatch) {
                    const command = commandMatch[1].toUpperCase();
                    const reason = reasonMatch ? reasonMatch[1] : 'No reason provided';
                    
                    logThought(`AI Decision: ${command} - ${reason}`, 'AI');
                    
                    const success = await sendCommand(command);
                    if (success) {
                        logThought(`Command ${command} executed successfully`, 'SUCCESS');
                    }
                } else {
                    logThought('AI response format error', 'ERROR');
                }
                
            } catch (error) {
                logThought('Gemini API error: ' + error.message, 'ERROR');
            }
        }
        
        // Toggle autonomous mode
        function toggleAutonomous() {
            if (!autonomousMode) {
                startAutonomous();
            } else {
                stopAutonomous();
            }
        }
        
        function startAutonomous() {
            autonomousMode = true;
            const interval = parseInt(document.getElementById('commandInterval').value) * 1000;
            
            document.getElementById('autonomousBtn').textContent = '‚è∏Ô∏è Pause Autonomous Mode';
            document.getElementById('autonomousBtn').className = 'btn-danger';
            document.getElementById('aiStatus').textContent = 'ü§ñ AI: ACTIVE';
            document.getElementById('aiStatus').className = 'status-badge status-active';
            document.getElementById('currentMode').textContent = 'AUTO';
            
            logThought('üöó Autonomous mode STARTED - AI is now in control!', 'SUCCESS');
            
            // First decision immediately
            askGeminiForDecision();
            
            // Then every interval
            autonomousInterval = setInterval(askGeminiForDecision, interval);
        }
        
        function stopAutonomous() {
            autonomousMode = false;
            clearInterval(autonomousInterval);
            
            document.getElementById('autonomousBtn').textContent = 'ü§ñ Start Autonomous Mode';
            document.getElementById('autonomousBtn').className = 'btn-success';
            document.getElementById('aiStatus').textContent = 'AI: Idle';
            document.getElementById('aiStatus').className = 'status-badge status-disconnected';
            document.getElementById('currentMode').textContent = 'MANUAL';
            
            sendCommand('STOP');
            logThought('Autonomous mode STOPPED', 'INFO');
        }
        
        // Emergency stop
        async function emergencyStop() {
            stopAutonomous();
            await sendCommand('STOP');
            logThought('üö® EMERGENCY STOP activated!', 'ERROR');
        }
        
        // Manual command (pauses autonomous)
        async function sendManualCommand(command) {
            if (autonomousMode) {
                stopAutonomous();
                logThought('Autonomous mode paused for manual control', 'INFO');
            }
            
            await sendCommand(command);
            logThought(`Manual command: ${command}`, 'INFO');
        }
        
        // Log AI thoughts
        function logThought(message, type = 'INFO') {
            const thoughtsDiv = document.getElementById('aiThoughts');
            const timestamp = new Date().toLocaleTimeString();
            
            const colors = {
                'AI': '#fbd38d',
                'SUCCESS': '#48bb78',
                'ERROR': '#f56565',
                'INFO': '#81e6d9'
            };
            
            const entry = document.createElement('div');
            entry.className = 'thought-entry';
            entry.innerHTML = `
                <div class="thought-time">[${timestamp}]</div>
                <div style="color: ${colors[type] || '#cbd5e0'}">${message}</div>
            `;
            
            thoughtsDiv.appendChild(entry);
            thoughtsDiv.scrollTop = thoughtsDiv.scrollHeight;
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (autonomousMode) return;
            
            switch(e.key) {
                case 'ArrowUp':
                    e.preventDefault();
                    sendManualCommand('FORWARD');
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    sendManualCommand('BACKWARD');
                    break;
                case 'ArrowLeft':
                    e.preventDefault();
                    sendManualCommand('LEFT');
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    sendManualCommand('RIGHT');
                    break;
                case ' ':
                    e.preventDefault();
                    sendManualCommand('STOP');
                    break;
            }
        });
        
        // Initial log
        logThought('AI Autonomous Car Controller initialized', 'SUCCESS');
        logThought('Setup: 1) Enter ESP32 IP 2) Test connection 3) Add Gemini API key 4) Start camera 5) Start autonomous mode', 'INFO');
    </script>
</body>
</html>
