<!DOCTYPE html>
<html>
<head>
  <title>ESP32 Car Control</title>
  <style>
    body { 
      text-align: center; 
      font-family: Arial; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      padding: 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }
    button { 
      padding: 15px 30px; 
      font-size: 20px; 
      margin: 10px; 
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .control-btn {
      background: #4CAF50;
      color: white;
      font-weight: bold;
    }
    .control-btn:hover {
      background: #45a049;
      transform: scale(1.05);
    }
    .stop-btn {
      background: #f44336;
      color: white;
    }
    .stop-btn:hover {
      background: #da190b;
      transform: scale(1.05);
    }
    .test-btn {
      background: #008CBA;
      color: white;
    }
    .test-btn:hover {
      background: #007B9A;
    }
    #status { 
      margin: 20px; 
      font-size: 18px;
      font-weight: bold;
    }
    .connected { color: #4CAF50; }
    .disconnected { color: #f44336; }
    input {
      padding: 12px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      width: 300px;
      margin: 10px;
    }
    #log {
      background: rgba(0,0,0,0.3);
      color: #fff;
      border-radius: 8px;
      margin-top: 20px;
    }
    .controls-grid {
      display: grid;
      grid-template-areas: 
        ". forward ."
        "left stop right"
        ". backward .";
      gap: 10px;
      justify-content: center;
      margin: 30px 0;
    }
    #forward { grid-area: forward; }
    #left { grid-area: left; }
    #stop { grid-area: stop; }
    #right { grid-area: right; }
    #backward { grid-area: backward; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöó ESP32 Car Controller</h1>
    <p>Control your ESP32 car remotely via GitHub Pages</p>

    <div class="connection-section">
      <label><strong>ESP32 Server URL:</strong></label><br>
      <input type="text" id="serverUrl" placeholder="http://192.168.1.100:8080" value="http://192.168.1.100:8080">
      <br>
      <button class="test-btn" onclick="testConnection()">Test Connection</button>
    </div>

    <p id="status" class="disconnected">üî¥ Status: Not connected</p>

    <div class="controls-grid">
      <button id="forward" class="control-btn" onclick="sendCommand('forward')">‚Üë Forward</button>
      <button id="left" class="control-btn" onclick="sendCommand('left')">‚Üê Left</button>
      <button id="stop" class="stop-btn" onclick="sendCommand('stop')">‚èπ Stop</button>
      <button id="right" class="control-btn" onclick="sendCommand('right')">‚Üí Right</button>
      <button id="backward" class="control-btn" onclick="sendCommand('backward')">‚Üì Backward</button>
    </div>

    <div>
      <h3>Command Log</h3>
      <div id="log" style="border:1px solid #ccc; padding:15px; min-height:150px; text-align:left; font-family: monospace;"></div>
    </div>
  </div>

  <script>
    let isConnected = false;

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#51cf66' : '#fff';
      logDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function testConnection() {
      const url = document.getElementById('serverUrl').value.trim();
      if (!url) {
        alert('Please enter server URL');
        return;
      }

      log(`Testing connection to: ${url}`, 'info');

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(url + '/ping', {
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        if (response.ok) {
          const data = await response.text();
          document.getElementById('status').textContent = 'üü¢ Status: Connected to ESP32';
          document.getElementById('status').className = 'connected';
          isConnected = true;
          log('Successfully connected to ESP32 server!', 'success');
        } else {
          throw new Error(`Server responded with status: ${response.status}`);
        }
      } catch (error) {
        document.getElementById('status').textContent = 'üî¥ Status: Connection failed';
        document.getElementById('status').className = 'disconnected';
        isConnected = false;
        
        if (error.name === 'AbortError') {
          log('Connection timeout - Server not responding', 'error');
        } else {
          log('Connection failed: ' + error.message, 'error');
        }
      }
    }

    async function sendCommand(command) {
      if (!isConnected) {
        alert('Please test connection first!');
        return;
      }

      const baseUrl = document.getElementById('serverUrl').value.trim();
      if (!baseUrl) {
        alert('Please set server URL first');
        return;
      }

      // Visual feedback
      const button = event.target;
      const originalText = button.textContent;
      button.textContent = '‚è≥ Sending...';
      button.disabled = true;

      try {
        const response = await fetch(baseUrl + '/command', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ command: command })
        });

        if (response.ok) {
          const data = await response.text();
          log(`Command sent: ${command} - Response: ${data}`, 'success');
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        log(`Error sending command '${command}': ${error.message}`, 'error');
        document.getElementById('status').textContent = 'üî¥ Status: Connection lost';
        document.getElementById('status').className = 'disconnected';
        isConnected = false;
      } finally {
        // Restore button
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 500);
      }
    }

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
      if (!isConnected) return;
      
      switch(e.key) {
        case 'ArrowUp':
          sendCommand('forward');
          break;
        case 'ArrowLeft':
          sendCommand('left');
          break;
        case 'ArrowRight':
          sendCommand('right');
          break;
        case 'ArrowDown':
          sendCommand('backward');
          break;
        case ' ':
          e.preventDefault();
          sendCommand('stop');
          break;
      }
    });

    // Initial log
    log('Web controller initialized. Set your ESP32 server URL and test connection.', 'info');
  </script>
</body>
</html>
